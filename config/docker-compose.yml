# ============================================
# DOCKER COMPOSE OTIMIZADO - IA-Test Project
# ============================================
# 
# Uso:
#   - Stack completa: docker compose up
#   - Stack core: docker compose --profile core up
#   - Stack streamlit: docker compose --profile streamlit up
#   - Stack tools: docker compose --profile tools up
#   - Apenas serviços específicos: docker compose up api frontend agent-dashboard
#
# Profiles disponíveis:
#   - core: Serviços essenciais (neo4j, api, frontend, agent-dashboard)
#   - streamlit: Aplicações Streamlit (bot, loader, pdf-bot)
#   - tools: Ferramentas adicionais (mcp-manager, kestra)
#   - ollama: Ollama local (opcional)
#   - pull-model: Pull model (one-time job)

# Variáveis compartilhadas
x-common-variables: &common-vars
  NEO4J_URI: ${NEO4J_URI:-neo4j://database:7687}
  NEO4J_USERNAME: ${NEO4J_USERNAME:-neo4j}
  NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
  OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
  LLM: ${LLM:-llama2}
  EMBEDDING_MODEL: ${EMBEDDING_MODEL:-sentence_transformer}
  LANGCHAIN_ENDPOINT: ${LANGCHAIN_ENDPOINT:-https://api.smith.langchain.com}
  LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2:-false}
  LANGCHAIN_PROJECT: ${LANGCHAIN_PROJECT:-}
  LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY:-}
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
  AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-}
  SUPABASE_URL: ${SUPABASE_URL:-}
  SUPABASE_KEY: ${SUPABASE_KEY:-}
  NEON_DATABASE_URL: ${NEON_DATABASE_URL:-}
  MONGODB_URI: ${MONGODB_URI:-}
  MONGODB_DATABASE: ${MONGODB_DATABASE:-default}

x-common-volumes: &common-volumes
  - ${PWD}/embedding_model:/embedding_model

x-common-network: &common-network
  networks:
    - ia-test-network

x-common-depends-db: &common-depends-db
  depends_on:
    database:
      condition: service_healthy

services:
  # ============================================
  # INFRAESTRUTURA
  # ============================================

  database:
    profiles: ["core"]
    image: neo4j:5.26
    container_name: ia-test-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_config:/config
      - neo4j_plugins:/plugins
    environment:
      # Formato correto conforme documentação: username/password
      NEO4J_AUTH: ${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-password}
      # Plugin APOC para procedimentos avançados
      NEO4J_PLUGINS: '["apoc"]'
      # Configurações adicionais
      NEO4J_db_tx__log_rotation_retention__policy: "false"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 30s
      retries: 10
    restart: always
    <<: *common-network

  # Ollama (opcional - use profile: ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: ia-test-ollama
    profiles: ["ollama"]
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    <<: *common-network

  # Pull Model (one-time job - use profile: pull-model)
  pull-model:
    image: genai-stack/pull-model:latest
    build:
      context: ..
      dockerfile: docker/pull_model.Dockerfile
    environment:
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      LLM: ${LLM:-llama2}
    profiles: ["pull-model"]
    restart: "no"
    <<: *common-network

  # ============================================
  # STACK CORE - Serviços Essenciais
  # ============================================
  # Profile: core (ativado por padrão)

  api:
    profiles: ["core"]
    build:
      context: ..
      dockerfile: docker/api.Dockerfile
    container_name: ia-test-api
    volumes:
      - ${PWD}/embedding_model:/embedding_model
      - ${PWD}/src:/app/src
      - ${PWD}/config:/app/config
    environment:
      <<: *common-vars
    ports:
      - "8504:8504"
    command: uvicorn src.apps.api_v2:app --host 0.0.0.0 --port 8504 --reload
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 http://localhost:8504/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    <<: *common-network
    depends_on:
      database:
        condition: service_healthy

  front-end:
    profiles: ["core"]
    build:
      context: ..
      dockerfile: docker/front-end.Dockerfile
    container_name: ia-test-frontend
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "8505:8505"
    restart: unless-stopped
    <<: *common-network

  # Next.js Frontend (novo)
  frontend-nextjs:
    profiles: ["core"]
    build:
      context: ..
      dockerfile: docker/frontend-nextjs.Dockerfile
    container_name: ia-test-frontend-nextjs
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://api:8504
      NEXT_PUBLIC_WS_URL: ws://api:8504
    restart: unless-stopped
    <<: *common-network

  agent-dashboard:
    profiles: ["core"]
    build:
      context: ..
      dockerfile: docker/agent_dashboard.Dockerfile
    container_name: ia-test-agent-dashboard
    volumes:
      - ${PWD}/.env:/app/.env
      - ${PWD}/src:/app/src
      - ${PWD}/config:/app/config
    environment:
      <<: *common-vars
    ports:
      - "8507:8507"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 http://localhost:8507/_stcore/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    <<: *common-network
    depends_on:
      database:
        condition: service_healthy

  # ============================================
  # STACK STREAMLIT - Aplicações Streamlit
  # ============================================

  bot:
    build:
      context: ..
      dockerfile: docker/bot.Dockerfile
    container_name: ia-test-bot
    volumes:
      - ${PWD}/embedding_model:/embedding_model
    environment:
      <<: *common-vars
    ports:
      - "8501:8501"
    profiles: ["streamlit"]
    restart: unless-stopped
    <<: *common-network
    depends_on:
      database:
        condition: service_healthy

  loader:
    build:
      context: ..
      dockerfile: docker/loader.Dockerfile
    container_name: ia-test-loader
    volumes:
      - ${PWD}/embedding_model:/embedding_model
    environment:
      <<: *common-vars
    ports:
      - "8502:8502"
    profiles: ["streamlit"]
    restart: unless-stopped
    <<: *common-network
    depends_on:
      database:
        condition: service_healthy

  pdf_bot:
    build:
      context: ..
      dockerfile: docker/pdf_bot.Dockerfile
    container_name: ia-test-pdf-bot
    environment:
      <<: *common-vars
    ports:
      - "8503:8503"
    profiles: ["streamlit"]
    restart: unless-stopped
    <<: *common-network
    depends_on:
      database:
        condition: service_healthy

  # ============================================
  # STACK TOOLS - Ferramentas Adicionais
  # ============================================

  mcp-manager:
    build:
      context: ..
      dockerfile: docker/mcp_manager.Dockerfile
    container_name: ia-test-mcp-manager
    volumes:
      - ${PWD}/mcp_servers.json:/app/mcp_servers.json
      - ${PWD}/embedding_model:/embedding_model
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      <<: *common-vars
      OBSIDIAN_VAULT_PATH: ${OBSIDIAN_VAULT_PATH:-}
      MCP_ENV_FILE: ${MCP_ENV_FILE:-.env}
    ports:
      - "8506:8506"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 http://localhost:8506/_stcore/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
    profiles: ["tools"]
    restart: unless-stopped
    <<: *common-network

  kestra:
    image: kestra/kestra:latest
    container_name: ia-test-kestra
    command: server standalone
    depends_on:
      kestra-postgres:
        condition: service_started
    ports:
      - "8080:8080"
    volumes:
      - kestra_workflows:/app/kestra_workflows
      - kestra_data:/app/kestra_data
    # Carrega o .env da raiz do projeto explicitamente
    env_file:
      - ../.env
    environment:
      # URL pública da UI (utilizada em notificações/links internos)
      KESTRA_SERVER_URL: http://localhost:8080
      # API Key do Gemini (lida do .env via Docker Compose)
      # O Kestra precisa dessa variável de ambiente para usar o Gemini
      KESTRA_GEMINI_API_KEY: ${GOOGLE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      # Configuração completa do Kestra via variável de ambiente
      # Nota: Para usar interpolação de variáveis no YAML, usamos uma sintaxe especial
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra-postgres:5432/kestra
            driver-class-name: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            type: standalone
            basic-auth:
              enabled: true
              # Credenciais da UI – seguem a regra: 8+ chars, maiúscula, minúscula e número
              username: "admin@localhost.dev"
              password: "K3str4P1"
          repository:
            type: postgres
          storage:
            type: local
            local:
              base-path: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmp-dir:
              path: "/tmp/kestra-wd/tmp"
          url: "http://localhost:8080/"
          ai:
            type: "gemini"
            gemini:
              # A API key é lida automaticamente da variável de ambiente KESTRA_GEMINI_API_KEY
              # Não é necessário especificar aqui se a variável estiver definida
              # Configure GOOGLE_API_KEY no arquivo .env na pasta raiz do projeto
              model-name: "gemini-2.5-flash"
    profiles: ["tools"]
    restart: unless-stopped
    <<: *common-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 http://localhost:8080/api/v1/configs || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Banco de dados PostgreSQL usado pelo Kestra
  kestra-postgres:
    image: postgres:16
    container_name: ia-test-kestra-postgres
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    volumes:
      - kestra_postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    <<: *common-network

# ============================================
# NETWORKS
# ============================================
networks:
  ia-test-network:
    name: ia-test-network
    driver: bridge

# ============================================
# VOLUMES
# ============================================
volumes:
  neo4j_data:
    name: ia-test-neo4j-data
    driver: local
  neo4j_logs:
    name: ia-test-neo4j-logs
    driver: local
  neo4j_config:
    name: ia-test-neo4j-config
    driver: local
  neo4j_plugins:
    name: ia-test-neo4j-plugins
    driver: local
  ollama_data:
    name: ia-test-ollama-data
    driver: local
  kestra_workflows:
    name: ia-test-kestra-workflows
    driver: local
  kestra_data:
    name: ia-test-kestra-data
    driver: local
  kestra_postgres_data:
    name: ia-test-kestra-postgres-data
    driver: local
